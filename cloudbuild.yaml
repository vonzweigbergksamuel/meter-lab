# How to add a new service
# 1. Add the _IMAGE_NAME_SERVICENAME in substitutions
# 2. Copy the step 1 with the build and push steps with the dockerfile
# 3. Add the sed futher down and replace the image name in compose.yaml file with the _IMAGE_NAME_XXX you created in substitutions.

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _IMAGE_NAME_BACKEND: "gcr.io/${PROJECT_ID}/backend/gcpdevops-prod:${SHORT_SHA}"
  _IMAGE_NAME_WEB: "gcr.io/${PROJECT_ID}/web/gcpdevops-prod:${SHORT_SHA}"
  _IMAGE_NAME_AUTH: "gcr.io/${PROJECT_ID}/auth/gcpdevops-prod:${SHORT_SHA}"
  _CLUSTER_NAME: "meter-lab-production-standard-cluster"
  _NAMESPACE: "meter-lab"
  _LOCATION: "europe-north2":
  _BETTER_AUTH_SECRET: "some-secretsome-secretsome-secretsome-secretsome-secretsome-secret"
  _BETTER_AUTH_URL: "http://34.51.221.35"
  _ADMIN_EMAIL: "admin@example.com"
  _ADMIN_PASSWORD: changeme123
  _ADMIN_NAME: "Admin User"

steps:
  # Step 1: Build Docker images with SHA-based tagging
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'apps/backend/Dockerfile', '-t', '${_IMAGE_NAME_BACKEND}', '.']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'apps/web/Dockerfile', '-t', '${_IMAGE_NAME_WEB}', '--build-arg', 'PUBLIC_BACKEND_URL=http://34.51.192.219', '--build-arg', 'PUBLIC_AUTH_URL=http://34.51.221.35', '--build-arg', 'PUBLIC_WEBSOCKET_URL=ws://34.51.192.219:5071', '.']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'apps/auth/Dockerfile', '-t', '${_IMAGE_NAME_AUTH}', '.']

  # Step 2: Push Docker image to Google Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_IMAGE_NAME_BACKEND}']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_IMAGE_NAME_WEB}']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_IMAGE_NAME_AUTH}']

  # 2) Install Kompose
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -c
      - |
        curl -L https://github.com/kubernetes/kompose/releases/download/v1.37.0/kompose-linux-amd64 -o kompose
        chmod +x kompose

  # 3) Convert docker-compose â†’ manifest
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -c
      - |
        mkdir -p infra/gke/generated
        /workspace/kompose convert -f compose.yaml --stdout > infra/gke/generated/komposed.yaml

    # Step 3: Replace placeholder `image-name:latest` in `komposed.yaml` with actual image name 
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        # REPLACE IMAGE NAME IN KOMPOSE.YAML
        sed -i "s|backend:latest|${_IMAGE_NAME_BACKEND}|g" infra/gke/generated/komposed.yaml
        sed -i "s|web:latest|${_IMAGE_NAME_WEB}|g" infra/gke/generated/komposed.yaml
        sed -i "s|auth:latest|${_IMAGE_NAME_AUTH}|g" infra/gke/generated/komposed.yaml

        sed -i 's|value: development|value: testing|g' infra/gke/generated/komposed.yaml
        sed -i '/hostPort/d' infra/gke/generated/komposed.yaml
        sed -i 's/imagePullPolicy: Never/imagePullPolicy: Always/g' infra/gke/generated/komposed.yaml
        awk '/port:/ && !/name:/ {gsub(/^[[:space:]]*- port:/, "  - name: port\n    port:"); print; next} {print}' infra/gke/generated/komposed.yaml > infra/gke/generated/komposed.tmp && mv infra/gke/generated/komposed.tmp infra/gke/generated/komposed.yaml

  # Cleanup previous gke-deploy outputs to avoid conflicts
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        rm -rf output || true

  # 5a) Deploy FAS 1: manual prereqs (namespace, secrets, configmaps, pvcs, crds, osv)
  - name: "gcr.io/cloud-builders/gke-deploy"
    args:
      - run
      - --location=${_LOCATION}
      - --cluster=${_CLUSTER_NAME}
      - --namespace=${_NAMESPACE}
      - --filename=infra/k8s/gke

  # Apply kompose-generated resources and show diagnostics
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --region ${_LOCATION}
        kubectl apply -f infra/gke/generated/ --namespace=${_NAMESPACE}
        sleep 5

  # Wait for auth-db to be ready
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --region ${_LOCATION}
        kubectl wait --for=condition=ready pod -l app=auth-db --namespace=${_NAMESPACE} --timeout=300s || true

  # Run auth database migrations
  # Note: Ensure BETTER_AUTH_SECRET and BETTER_AUTH_URL are set as Cloud Build substitutions or secrets
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --region ${_LOCATION}
        kubectl run auth-migrate-${SHORT_SHA} \
          --image=${_IMAGE_NAME_AUTH} \
          --namespace=${_NAMESPACE} \
          --restart=Never \
          --env="DATABASE_URL=postgres://postgres:postgres@auth-db:5432/auth" \
          --env="BETTER_AUTH_SECRET=${_BETTER_AUTH_SECRET}" \
          --env="BETTER_AUTH_URL=${_BETTER_AUTH_URL}" \
          --command -- sh -c "cd apps/auth && node dist/scripts/migrate.js"
        kubectl wait --for=condition=complete pod/auth-migrate-${SHORT_SHA} --namespace=${_NAMESPACE} --timeout=300s || true
        kubectl logs auth-migrate-${SHORT_SHA} --namespace=${_NAMESPACE} || true
        kubectl delete pod auth-migrate-${SHORT_SHA} --namespace=${_NAMESPACE} --ignore-not-found=true

  # Seed admin user
  # Note: Ensure ADMIN_EMAIL, ADMIN_PASSWORD, ADMIN_NAME are set as Cloud Build secrets
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --region ${_LOCATION}
        kubectl run auth-seed-${SHORT_SHA} \
          --image=${_IMAGE_NAME_AUTH} \
          --namespace=${_NAMESPACE} \
          --restart=Never \
          --env="DATABASE_URL=postgres://postgres:postgres@auth-db:5432/auth" \
          --env="BETTER_AUTH_SECRET=${_BETTER_AUTH_SECRET}" \
          --env="BETTER_AUTH_URL=${_BETTER_AUTH_URL}" \
          --env="ADMIN_EMAIL=${_ADMIN_EMAIL}" \
          --env="ADMIN_PASSWORD=${_ADMIN_PASSWORD}" \
          --env="ADMIN_NAME=${_ADMIN_NAME}" \
          --command -- sh -c "cd apps/auth && node dist/scripts/seed-admin.js"
        kubectl wait --for=condition=complete pod/auth-seed-${SHORT_SHA} --namespace=${_NAMESPACE} --timeout=300s || true
        kubectl logs auth-seed-${SHORT_SHA} --namespace=${_NAMESPACE} || true
        kubectl delete pod auth-seed-${SHORT_SHA} --namespace=${_NAMESPACE} --ignore-not-found=true